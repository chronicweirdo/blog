<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="Building several iterations of a generic upsert writer from a Spark stream to MongoDB.">

    <title>Spark Foreach Mongo Upsert Writer</title>
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico?">

    <link id="theme" rel="stylesheet" type="text/css" href="main.css">
    <link id="theme" rel="stylesheet" type="text/css" href="code.css">
</head>

<body>
    <p class="header">
        <a class="home" href="../index.html">home</a>
        <span>/</span>
        <span class="date">2018.10.02 19:00</span>
        <span>/</span><span class="tag">scala</span>
        <span>/</span><span class="tag">apache spark</span>
        <span>/</span><span class="tag">mongo db</span>
        <span>/</span><span class="tag">apache kafka</span>
        <span>/</span><span class="tag">big data</span>
    </p>
    <h1 id="spark-foreach-mongo-upsert-writer">Spark Foreach Mongo Upsert Writer</h1>
    <h2 id="introduction">Introduction</h2>
    <p>We need a way to write or update results in the Mongo DB after obtaining those results through Spark Structured Stream processing. We need a sollution that can be easily adapted for each Spark job we wish to run, which means our sollution should be able to save any case class we define as the result (and preferably it should also be able to save deep case classes).</p>
    <p>Our example Spark job is inclued below:</p>
    <div class="sourceCode" id="cb1">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb1-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb1-2" data-line-number="2"></a>
<a class="sourceLine" id="cb1-3" data-line-number="3"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.{Dataset, SparkSession}</a>
<a class="sourceLine" id="cb1-4" data-line-number="4"></a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">SimpleResult</span>(_id: String, info: String, value: Int)</a>
<a class="sourceLine" id="cb1-6" data-line-number="6"></a>
<a class="sourceLine" id="cb1-7" data-line-number="7"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">MongoResultEntry</span>(entryId: String, value: String)</a>
<a class="sourceLine" id="cb1-8" data-line-number="8"></a>
<a class="sourceLine" id="cb1-9" data-line-number="9"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">DeepMongoResult</span>(_id: String, info: MongoResultEntry, value: Map[String, Int])</a>
<a class="sourceLine" id="cb1-10" data-line-number="10"></a>
<a class="sourceLine" id="cb1-11" data-line-number="11"><span class="kw">object</span> StructuredStreamingToMongoGeneric <span class="kw">extends</span> App {</a>
<a class="sourceLine" id="cb1-12" data-line-number="12"></a>
<a class="sourceLine" id="cb1-13" data-line-number="13">  <span class="kw">val</span> spark = SparkSession</a>
<a class="sourceLine" id="cb1-14" data-line-number="14">    .<span class="fu">builder</span></a>
<a class="sourceLine" id="cb1-15" data-line-number="15">    .<span class="fu">appName</span>(<span class="kw">this</span>.<span class="fu">getClass</span>.<span class="fu">getName</span>)</a>
<a class="sourceLine" id="cb1-16" data-line-number="16">    .<span class="fu">master</span>(<span class="st">&quot;local[2]&quot;</span>)</a>
<a class="sourceLine" id="cb1-17" data-line-number="17">    .<span class="fu">getOrCreate</span>()</a>
<a class="sourceLine" id="cb1-18" data-line-number="18"></a>
<a class="sourceLine" id="cb1-19" data-line-number="19">  <span class="kw">import</span> spark.<span class="fu">implicits</span>._</a>
<a class="sourceLine" id="cb1-20" data-line-number="20"></a>
<a class="sourceLine" id="cb1-21" data-line-number="21">  <span class="kw">val</span> frame = spark.<span class="fu">readStream</span></a>
<a class="sourceLine" id="cb1-22" data-line-number="22">    <span class="fu">.format</span>(<span class="st">&quot;kafka&quot;</span>)</a>
<a class="sourceLine" id="cb1-23" data-line-number="23">    .<span class="fu">option</span>(<span class="st">&quot;kafka.bootstrap.servers&quot;</span>, <span class="st">&quot;localhost:9092&quot;</span>)</a>
<a class="sourceLine" id="cb1-24" data-line-number="24">    .<span class="fu">option</span>(<span class="st">&quot;startingOffsets&quot;</span>, <span class="st">&quot;earliest&quot;</span>)</a>
<a class="sourceLine" id="cb1-25" data-line-number="25">    .<span class="fu">option</span>(<span class="st">&quot;subscribe&quot;</span>, <span class="st">&quot;data&quot;</span>)</a>
<a class="sourceLine" id="cb1-26" data-line-number="26">    .<span class="fu">load</span>()</a>
<a class="sourceLine" id="cb1-27" data-line-number="27"></a>
<a class="sourceLine" id="cb1-28" data-line-number="28">  <span class="kw">val</span> results: Dataset[DeepMongoResult] = frame.<span class="fu">selectExpr</span>(<span class="st">&quot;CAST(key AS STRING)&quot;</span>, <span class="st">&quot;CAST(value AS STRING)&quot;</span>)</a>
<a class="sourceLine" id="cb1-29" data-line-number="29">    .<span class="fu">as</span>[(String, String)]</a>
<a class="sourceLine" id="cb1-30" data-line-number="30">    .<span class="fu">map</span> { <span class="kw">case</span> (key, value) =&gt;</a>
<a class="sourceLine" id="cb1-31" data-line-number="31">      <span class="co">// do some processing</span></a>
<a class="sourceLine" id="cb1-32" data-line-number="32">    }</a>
<a class="sourceLine" id="cb1-33" data-line-number="33"></a>
<a class="sourceLine" id="cb1-34" data-line-number="34">  <span class="kw">val</span> query = results</a>
<a class="sourceLine" id="cb1-35" data-line-number="35">    .<span class="fu">writeStream</span></a>
<a class="sourceLine" id="cb1-36" data-line-number="36">    .<span class="fu">outputMode</span>(<span class="st">&quot;complete&quot;</span>)</a>
<a class="sourceLine" id="cb1-37" data-line-number="37">    .<span class="fu">foreach</span>(</a>
<a class="sourceLine" id="cb1-38" data-line-number="38">      <span class="kw">new</span> <span class="fu">MongoUpsertWriter</span>(<span class="st">&quot;mongodb://localhost:27017&quot;</span>, <span class="st">&quot;local&quot;</span>, <span class="st">&quot;results_collection&quot;</span>))</a>
<a class="sourceLine" id="cb1-39" data-line-number="39">    .<span class="fu">start</span>()</a>
<a class="sourceLine" id="cb1-40" data-line-number="40"></a>
<a class="sourceLine" id="cb1-41" data-line-number="41">  query.<span class="fu">awaitTermination</span>()</a>
<a class="sourceLine" id="cb1-42" data-line-number="42">}</a></code></pre>
    </div>
    <p>The Spark job:</p>
    <ul>
        <li>creates a Spark session</li>
        <li>subscribes to the <strong>data</strong> topic in Kafka (local server)</li>
        <li>loads all key/values from the <strong>data</strong> topic and processes them</li>
        <li>sends the results to our custom <code>MongoUpsertWriter</code> for writing</li>
    </ul>
    <p>Next I’ll go over a few approaches to make a <code>MongoUpsertWriter</code> class that can help us in this
        sitation.</p>
    <h2 id="full-featured-sollution">Full-Featured Sollution</h2>
    <p>This sollution supports upserts to Mongo and can handle any deep case class, but the implementation is not
        generic. This means that, while most of the code for the <code>MongoUpsertWriter</code> can be reused when we
        want to write a new case class to Mongo, we need to copy the code into a new writer class and replace all
        references from the old (<code>DeepMongoResult</code>) case class to our new case class.</p>
    <div class="sourceCode" id="cb2">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">import</span> com.<span class="fu">mongodb</span>.<span class="fu">client</span>.<span class="fu">model</span>.<span class="fu">ReplaceOptions</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">ForeachWriter</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">bson</span>.<span class="fu">codecs</span>.<span class="fu">configuration</span>.<span class="fu">CodecRegistries</span>.{fromProviders, fromRegistries}</a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>._</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">bson</span>.<span class="fu">codecs</span>.{DEFAULT_CODEC_REGISTRY, Macros}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Filters</span>._</a>
<a class="sourceLine" id="cb2-9" data-line-number="9"></a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span></a>
<a class="sourceLine" id="cb2-11" data-line-number="11"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>.<span class="fu">Duration</span></a>
<a class="sourceLine" id="cb2-12" data-line-number="12"></a>
<a class="sourceLine" id="cb2-13" data-line-number="13"><span class="kw">class</span> <span class="fu">MongoUpsertWriter</span>(connectionString: String,</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">                        databaseName: String,</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">                        collectionName: String) <span class="kw">extends</span> ForeachWriter[DeepMongoResult] {</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  <span class="kw">var</span> mongoClient: MongoClient = _</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  <span class="kw">var</span> database: MongoDatabase = _</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">  <span class="kw">var</span> collection: MongoCollection[DeepMongoResult] = _</a>
<a class="sourceLine" id="cb2-20" data-line-number="20"></a>
<a class="sourceLine" id="cb2-21" data-line-number="21">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">open</span>(partitionId: Long, version: Long): Boolean = {</a>
<a class="sourceLine" id="cb2-22" data-line-number="22">    mongoClient = <span class="fu">MongoClient</span>(connectionString)</a>
<a class="sourceLine" id="cb2-23" data-line-number="23">    <span class="kw">val</span> codecRegistry = <span class="fu">fromRegistries</span>(<span class="fu">fromProviders</span>(</a>
<a class="sourceLine" id="cb2-24" data-line-number="24">      Macros.<span class="fu">createCodecProvider</span>[DeepMongoResult](),</a>
<a class="sourceLine" id="cb2-25" data-line-number="25">      Macros.<span class="fu">createCodecProvider</span>[MongoResultEntry]()</a>
<a class="sourceLine" id="cb2-26" data-line-number="26">    ), DEFAULT_CODEC_REGISTRY)</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    database = mongoClient.<span class="fu">getDatabase</span>(databaseName).<span class="fu">withCodecRegistry</span>(codecRegistry)</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">    collection = database.<span class="fu">getCollection</span>[DeepMongoResult](collectionName)</a>
<a class="sourceLine" id="cb2-29" data-line-number="29">    <span class="kw">true</span></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb2-31" data-line-number="31"></a>
<a class="sourceLine" id="cb2-32" data-line-number="32">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">process</span>(value: DeepMongoResult): Unit = {</a>
<a class="sourceLine" id="cb2-33" data-line-number="33">    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb2-34" data-line-number="34">      <span class="kw">val</span> options = <span class="kw">new</span> <span class="fu">ReplaceOptions</span>().<span class="fu">upsert</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb2-35" data-line-number="35"></a>
<a class="sourceLine" id="cb2-36" data-line-number="36">      <span class="kw">val</span> observable = collection.<span class="fu">replaceOne</span>(</a>
<a class="sourceLine" id="cb2-37" data-line-number="37">        <span class="fu">equal</span>(<span class="st">&quot;_id&quot;</span>, value._id),</a>
<a class="sourceLine" id="cb2-38" data-line-number="38">        value,</a>
<a class="sourceLine" id="cb2-39" data-line-number="39">        options</a>
<a class="sourceLine" id="cb2-40" data-line-number="40">      )</a>
<a class="sourceLine" id="cb2-41" data-line-number="41">      Await.<span class="fu">result</span>(observable.<span class="fu">toFuture</span>(), Duration.<span class="fu">Inf</span>)</a>
<a class="sourceLine" id="cb2-42" data-line-number="42">    } <span class="kw">catch</span> {</a>
<a class="sourceLine" id="cb2-43" data-line-number="43">      <span class="kw">case</span> t: Throwable =&gt; <span class="fu">println</span>(t)</a>
<a class="sourceLine" id="cb2-44" data-line-number="44">    }</a>
<a class="sourceLine" id="cb2-45" data-line-number="45">  }</a>
<a class="sourceLine" id="cb2-46" data-line-number="46"></a>
<a class="sourceLine" id="cb2-47" data-line-number="47">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">close</span>(errorOrNull: Throwable): Unit = {</a>
<a class="sourceLine" id="cb2-48" data-line-number="48">    <span class="co">//do nothing</span></a>
<a class="sourceLine" id="cb2-49" data-line-number="49">  }</a>
<a class="sourceLine" id="cb2-50" data-line-number="50">}</a></code></pre>
    </div>
    <ul>
        <li>the <code>open</code> method connects to the mongo server, database and collection provided as parameters
            in the constructor of the <code>MongoUpsertWriter</code></li>
        <li>also in the <code>open</code> method we invoke macros in the bson codecs library to create the codecs that
            are responsible with serializing our case classes into bson documents; all case classes we wish to save
            (including nested classes) must be provided here</li>
        <li>the <code>process</code> method is responsible with actually saving the data into Mongo</li>
        <li>we use the <code>replaceOne</code> method on the Mongo collection, with the upsert flag set to true; this
            way, if we already have a result with the current id, that result will be replaced, otherwise it will be
            inserted</li>
    </ul>
    <p>This sollution does all we need from it, but we need to create a new mongo writer class for each result we want
        to save into Mongo (so a new class for each Spark job).</p>
    <h2 id="generic-writer-sollution">Generic Writer Sollution</h2>
    <p>A better approach would be if we had a way to create a generic writer to which we provide the base case class
        that we want to save and then we just instantiate it with a new case class for each new result we want to save
        into Mongo. This, however, is a lot more complicated, mainly due to the fact that the bson codecs library uses
        Scala macros to dinamically create codecs for our case classes, and Scala macros do not support generics.</p>
    <p>Another aproach is for us to create our own way of converting the case class into a bson document using
        reflection (more exactly we create bson conversions that get applied to the objects in the database to update
        them). This is a working sollution for that, but it only works with <em>flat</em> case classes:</p>
    <div class="sourceCode" id="cb3">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">ForeachWriter</span></a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> org.<span class="fu">bson</span>.<span class="fu">BsonDocument</span></a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">bson</span>.<span class="fu">conversions</span>.<span class="fu">Bson</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">UpdateOptions</span></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"></a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>.<span class="fu">Duration</span></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>._</a>
<a class="sourceLine" id="cb3-11" data-line-number="11"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Filters</span>._</a>
<a class="sourceLine" id="cb3-12" data-line-number="12"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Updates</span>.{combine, set}</a>
<a class="sourceLine" id="cb3-13" data-line-number="13"></a>
<a class="sourceLine" id="cb3-14" data-line-number="14"><span class="kw">class</span> MongoUpsertWriter[T](connectionString: String,</a>
<a class="sourceLine" id="cb3-15" data-line-number="15">                           databaseName: String,</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">                           collectionName: String) <span class="kw">extends</span> ForeachWriter[T] {</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="kw">private</span> <span class="kw">val</span> ID_FIELD_NAME = <span class="st">&quot;_id&quot;</span></a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  <span class="kw">var</span> mongoClient: MongoClient = _</a>
<a class="sourceLine" id="cb3-21" data-line-number="21">  <span class="kw">var</span> database: MongoDatabase = _</a>
<a class="sourceLine" id="cb3-22" data-line-number="22">  <span class="kw">var</span> collection: MongoCollection[_] = _</a>
<a class="sourceLine" id="cb3-23" data-line-number="23"></a>
<a class="sourceLine" id="cb3-24" data-line-number="24">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">open</span>(partitionId: Long, version: Long): Boolean = {</a>
<a class="sourceLine" id="cb3-25" data-line-number="25">    mongoClient = <span class="fu">MongoClient</span>(connectionString)</a>
<a class="sourceLine" id="cb3-26" data-line-number="26">    database = mongoClient.<span class="fu">getDatabase</span>(databaseName)</a>
<a class="sourceLine" id="cb3-27" data-line-number="27">    collection = database.<span class="fu">getCollection</span>(collectionName)</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">    <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">  }</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">getId</span>(obj: T) = {</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">    <span class="kw">val</span> field = obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredField</span>(ID_FIELD_NAME)</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">    field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-34" data-line-number="34">    field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb3-35" data-line-number="35">  }</a>
<a class="sourceLine" id="cb3-36" data-line-number="36"></a>
<a class="sourceLine" id="cb3-37" data-line-number="37">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">getObjectFields</span>(obj: T): List[(String, AnyRef)] =</a>
<a class="sourceLine" id="cb3-38" data-line-number="38">    obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredFields</span>.<span class="fu">map</span>(field =&gt; {</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">      field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb3-40" data-line-number="40">      field.<span class="fu">getName</span> -&gt; field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb3-41" data-line-number="41">    }).<span class="fu">toList</span></a>
<a class="sourceLine" id="cb3-42" data-line-number="42"></a>
<a class="sourceLine" id="cb3-43" data-line-number="43">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">toSetQuery</span>(name: String, value: AnyRef) = <span class="fu">set</span>(name, value)</a>
<a class="sourceLine" id="cb3-44" data-line-number="44"></a>
<a class="sourceLine" id="cb3-45" data-line-number="45">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">toCombineQuery</span>(fields: List[(String, AnyRef)]) =</a>
<a class="sourceLine" id="cb3-46" data-line-number="46">    <span class="fu">combine</span>(fields.<span class="fu">filter</span>(f =&gt; f._<span class="dv">1</span> != ID_FIELD_NAME)</a>
<a class="sourceLine" id="cb3-47" data-line-number="47">      .<span class="fu">map</span>(f =&gt; <span class="fu">toSetQuery</span>(f._<span class="dv">1</span>, f._<span class="dv">2</span>)):_*)</a>
<a class="sourceLine" id="cb3-48" data-line-number="48"></a>
<a class="sourceLine" id="cb3-49" data-line-number="49">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">process</span>(value: T): Unit = {</a>
<a class="sourceLine" id="cb3-50" data-line-number="50">    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb3-51" data-line-number="51">      <span class="kw">val</span> options = <span class="kw">new</span> <span class="fu">UpdateOptions</span>().<span class="fu">upsert</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb3-52" data-line-number="52">      </a>
<a class="sourceLine" id="cb3-53" data-line-number="53">      <span class="kw">val</span> observable = collection.<span class="fu">updateOne</span>(</a>
<a class="sourceLine" id="cb3-54" data-line-number="54">        <span class="fu">equal</span>(<span class="st">&quot;_id&quot;</span>, <span class="fu">getId</span>(value)),</a>
<a class="sourceLine" id="cb3-55" data-line-number="55">        <span class="fu">toCombineQuery</span>(<span class="fu">getObjectFields</span>(value)),</a>
<a class="sourceLine" id="cb3-56" data-line-number="56">        options</a>
<a class="sourceLine" id="cb3-57" data-line-number="57">      )</a>
<a class="sourceLine" id="cb3-58" data-line-number="58">      Await.<span class="fu">result</span>(observable.<span class="fu">toFuture</span>(), Duration.<span class="fu">Inf</span>)</a>
<a class="sourceLine" id="cb3-59" data-line-number="59">    } <span class="kw">catch</span> {</a>
<a class="sourceLine" id="cb3-60" data-line-number="60">      <span class="kw">case</span> t: Throwable =&gt; <span class="fu">println</span>(t)</a>
<a class="sourceLine" id="cb3-61" data-line-number="61">    }</a>
<a class="sourceLine" id="cb3-62" data-line-number="62">  }</a>
<a class="sourceLine" id="cb3-63" data-line-number="63"></a>
<a class="sourceLine" id="cb3-64" data-line-number="64">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">close</span>(errorOrNull: Throwable): Unit = {</a>
<a class="sourceLine" id="cb3-65" data-line-number="65">    <span class="co">//do nothing</span></a>
<a class="sourceLine" id="cb3-66" data-line-number="66">  }</a>
<a class="sourceLine" id="cb3-67" data-line-number="67">}</a></code></pre>
    </div>
    <ul>
        <li>this writer is implemented as a generic of class <code>T</code></li>
        <li>this generic class can be passed to the <code>ForeachWriter</code> class we extend, because the Spark API
            supports generics</li>
        <li>the <code>open</code> method connects to the Mongo server, database and collection, based on parameters
            provided in the constructor</li>
        <li>the <code>process</code> method writes our generic object into the Mongo collection by executing an update
            operation with the upsert flag set to true; this update operation will look for an object by id and if it
            finds it it will apply a series of bson conversions (all of them <em>set</em> queries) to it to update its
            state to the current values</li>
        <li>the bson conversions that must be applied are obtained by the <code>toCombineQuery</code> method, by taking
            all fields of the class except the id field and creating <em>set</em> queries for each</li>
        <li>the fields of the case class are obtained by using reflection in the <code>getObjectFields</code> method,
            which works on any generic class but is not recursive, so it will only extract fields that are not
            primitives (making this recursive is a more complicated matter, we need to decide what classes we consider
            <em>primitives</em> and what classes we want to look into recursively, and this would depend on what
            classes are considered primitives by the Mongo library we use)</li>
    </ul>
    <p>This class is simpler to use, we just have to create the writer and instantiate it with the case class we want
        to write to Mongo (as long as it is a <em>flat</em> case class, it will work) as in the example below:</p>
    <div class="sourceCode" id="cb4">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">val</span> query = results</a>
<a class="sourceLine" id="cb4-2" data-line-number="2">    .<span class="fu">writeStream</span></a>
<a class="sourceLine" id="cb4-3" data-line-number="3">    .<span class="fu">outputMode</span>(<span class="st">&quot;complete&quot;</span>)</a>
<a class="sourceLine" id="cb4-4" data-line-number="4">    .<span class="fu">foreach</span>(</a>
<a class="sourceLine" id="cb4-5" data-line-number="5">      <span class="kw">new</span> MongoUpsertWriter[SimpleResult](<span class="st">&quot;mongodb://localhost:27017&quot;</span>, <span class="st">&quot;local&quot;</span>, <span class="st">&quot;results_collection&quot;</span>))</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">    .<span class="fu">start</span>()</a></code></pre>
    </div>
    <h2 id="more-powerful-generic-writer">More Powerful Generic Writer</h2>
    <p>We could, of course, expand the above sollution to a more generic implementation that can go into a deep case
        class structure and create the correct <em>set</em> queries to update the deep-structured bson document in the
        Mongo database.</p>
    <p>To test out how a deep dive into case classes would look, we can run the following program:</p>
    <div class="sourceCode" id="cb5">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb5-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb5-2" data-line-number="2"></a>
<a class="sourceLine" id="cb5-3" data-line-number="3"><span class="kw">import</span> scala.<span class="fu">collection</span>.<span class="fu">mutable</span>.<span class="fu">ListBuffer</span></a>
<a class="sourceLine" id="cb5-4" data-line-number="4"></a>
<a class="sourceLine" id="cb5-5" data-line-number="5"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">RRBaseClass</span>(str: String, i: Int)</a>
<a class="sourceLine" id="cb5-6" data-line-number="6"></a>
<a class="sourceLine" id="cb5-7" data-line-number="7"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">RRDeepClass</span>(str: String, bc: RRBaseClass)</a>
<a class="sourceLine" id="cb5-8" data-line-number="8"></a>
<a class="sourceLine" id="cb5-9" data-line-number="9"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">RRDeeperClass</span>(str: String, dc: RRDeepClass, m: Map[String, Int], l: List[String])</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11"><span class="kw">object</span> RecursiveReflection {</a>
<a class="sourceLine" id="cb5-12" data-line-number="12"></a>
<a class="sourceLine" id="cb5-13" data-line-number="13">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">isPrimitive</span>(obj: AnyRef) =</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">    obj.<span class="fu">isInstanceOf</span>[Int] ||</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">      obj.<span class="fu">isInstanceOf</span>[String] ||</a>
<a class="sourceLine" id="cb5-16" data-line-number="16">      obj.<span class="fu">isInstanceOf</span>[Double] ||</a>
<a class="sourceLine" id="cb5-17" data-line-number="17">      obj.<span class="fu">isInstanceOf</span>[Float] ||</a>
<a class="sourceLine" id="cb5-18" data-line-number="18">      obj.<span class="fu">isInstanceOf</span>[Long] ||</a>
<a class="sourceLine" id="cb5-19" data-line-number="19">      obj.<span class="fu">isInstanceOf</span>[Short] ||</a>
<a class="sourceLine" id="cb5-20" data-line-number="20">      obj.<span class="fu">isInstanceOf</span>[Byte] ||</a>
<a class="sourceLine" id="cb5-21" data-line-number="21">      obj.<span class="fu">isInstanceOf</span>[Boolean] ||</a>
<a class="sourceLine" id="cb5-22" data-line-number="22">      obj.<span class="fu">isInstanceOf</span>[Char] ||</a>
<a class="sourceLine" id="cb5-23" data-line-number="23">      obj.<span class="fu">isInstanceOf</span>[List[_]] ||</a>
<a class="sourceLine" id="cb5-24" data-line-number="24">      obj.<span class="fu">isInstanceOf</span>[Map[_, _]]</a>
<a class="sourceLine" id="cb5-25" data-line-number="25"></a>
<a class="sourceLine" id="cb5-26" data-line-number="26">  <span class="kw">def</span> <span class="fu">getObjectFields</span>(path: String, obj: AnyRef): List[(String, AnyRef)] = {</a>
<a class="sourceLine" id="cb5-27" data-line-number="27">    <span class="kw">val</span> res = <span class="kw">new</span> ListBuffer[(String, AnyRef)]()</a>
<a class="sourceLine" id="cb5-28" data-line-number="28">    obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredFields</span>.<span class="fu">foreach</span>(field =&gt; {</a>
<a class="sourceLine" id="cb5-29" data-line-number="29">      field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb5-30" data-line-number="30">      <span class="kw">val</span> value = field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb5-31" data-line-number="31"></a>
<a class="sourceLine" id="cb5-32" data-line-number="32">      <span class="kw">if</span> (<span class="fu">isPrimitive</span>(value)) {</a>
<a class="sourceLine" id="cb5-33" data-line-number="33">        res += (path + field.<span class="fu">getName</span> -&gt; value)</a>
<a class="sourceLine" id="cb5-34" data-line-number="34">      } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb5-35" data-line-number="35">        res ++= <span class="fu">getObjectFields</span>(field.<span class="fu">getName</span> + <span class="st">&quot;.&quot;</span>, value)</a>
<a class="sourceLine" id="cb5-36" data-line-number="36">      }</a>
<a class="sourceLine" id="cb5-37" data-line-number="37">    })</a>
<a class="sourceLine" id="cb5-38" data-line-number="38">    res.<span class="fu">toList</span></a>
<a class="sourceLine" id="cb5-39" data-line-number="39">  }</a>
<a class="sourceLine" id="cb5-40" data-line-number="40"></a>
<a class="sourceLine" id="cb5-41" data-line-number="41">  <span class="kw">def</span> <span class="fu">main</span>(args: Array[String]): Unit = {</a>
<a class="sourceLine" id="cb5-42" data-line-number="42">    <span class="fu">println</span>(<span class="fu">getObjectFields</span>(<span class="st">&quot;&quot;</span>, <span class="fu">RRBaseClass</span>(<span class="st">&quot;one&quot;</span>, <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb5-43" data-line-number="43">    <span class="fu">println</span>(<span class="fu">getObjectFields</span>(<span class="st">&quot;&quot;</span>, <span class="fu">RRDeepClass</span>(<span class="st">&quot;deeptwo&quot;</span>, <span class="fu">RRBaseClass</span>(<span class="st">&quot;two&quot;</span>, <span class="dv">2</span>))))</a>
<a class="sourceLine" id="cb5-44" data-line-number="44">    <span class="fu">println</span>(<span class="fu">getObjectFields</span>(<span class="st">&quot;&quot;</span>,</a>
<a class="sourceLine" id="cb5-45" data-line-number="45">      <span class="fu">RRDeeperClass</span>(<span class="st">&quot;deeperthree&quot;</span>,</a>
<a class="sourceLine" id="cb5-46" data-line-number="46">        <span class="fu">RRDeepClass</span>(<span class="st">&quot;deepthree&quot;</span>, <span class="fu">RRBaseClass</span>(<span class="st">&quot;three&quot;</span>, <span class="dv">3</span>)),</a>
<a class="sourceLine" id="cb5-47" data-line-number="47">        Map(<span class="st">&quot;map1&quot;</span> -&gt; <span class="dv">1</span>, <span class="st">&quot;map2&quot;</span> -&gt; <span class="dv">2</span>),</a>
<a class="sourceLine" id="cb5-48" data-line-number="48">        List(<span class="st">&quot;listone&quot;</span>, <span class="st">&quot;listtwo&quot;</span>)</a>
<a class="sourceLine" id="cb5-49" data-line-number="49">      )</a>
<a class="sourceLine" id="cb5-50" data-line-number="50">    ))</a>
<a class="sourceLine" id="cb5-51" data-line-number="51">  }</a>
<a class="sourceLine" id="cb5-52" data-line-number="52">}</a></code></pre>
    </div>
    <ul>
        <li>the <code>getObjectFields</code> method is designed to recursively go over the object fileds and return a
            list of keys and values, where the key is the path to the object field</li>
        <li>if the value of a variable is considered a primitive, based on the result of the <code>isPrimitive</code>
            method, we can just add that value to the list at the current path</li>
        <li>if the value is not a primitive, we add the current variable name to the current path and recursively run
            the <code>getObjectFields</code> method to extract the values of the object’s variables</li>
        <li>the <code>isPrimitive</code> method is designed to accept <code>List</code> and <code>Map</code> Scala
            objects as primitives (since the Mongo driver knows how to serialize these objects in the database), but
            itd does not account for the case where the <code>Map</code> or <code>List</code> contain non-primitive
            objects as values, which is a problem that still needs solving</li>
    </ul>
    <p>If you run the above example, you should get the following output:</p>
    <pre><code>List((str,one), (i,1))
List((str,deeptwo), (bc.str,two), (bc.i,2))
List((str,deeperthree), (dc.str,deepthree), (bc.str,three), (bc.i,3), (m,Map(map1 -&gt; 1, map2 -&gt; 2)), (l,List(listone, listtwo)))</code></pre>
    <p>The Mongo upsert writer (generic) based on this approach is detailed below:</p>
    <div class="sourceCode" id="cb7">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb7-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb7-2" data-line-number="2"></a>
<a class="sourceLine" id="cb7-3" data-line-number="3"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">ForeachWriter</span></a>
<a class="sourceLine" id="cb7-4" data-line-number="4"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>._</a>
<a class="sourceLine" id="cb7-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Filters</span>._</a>
<a class="sourceLine" id="cb7-6" data-line-number="6"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">UpdateOptions</span></a>
<a class="sourceLine" id="cb7-7" data-line-number="7"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Updates</span>.{combine, set}</a>
<a class="sourceLine" id="cb7-8" data-line-number="8"></a>
<a class="sourceLine" id="cb7-9" data-line-number="9"><span class="kw">import</span> scala.<span class="fu">collection</span>.<span class="fu">mutable</span>.<span class="fu">ListBuffer</span></a>
<a class="sourceLine" id="cb7-10" data-line-number="10"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span></a>
<a class="sourceLine" id="cb7-11" data-line-number="11"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>.<span class="fu">Duration</span></a>
<a class="sourceLine" id="cb7-12" data-line-number="12"></a>
<a class="sourceLine" id="cb7-13" data-line-number="13"><span class="kw">class</span> MongoUpsertWriter[T](connectionString: String,</a>
<a class="sourceLine" id="cb7-14" data-line-number="14">                           databaseName: String,</a>
<a class="sourceLine" id="cb7-15" data-line-number="15">                           collectionName: String) <span class="kw">extends</span> ForeachWriter[T] {</a>
<a class="sourceLine" id="cb7-16" data-line-number="16"></a>
<a class="sourceLine" id="cb7-17" data-line-number="17">  <span class="kw">private</span> <span class="kw">val</span> ID_FIELD_NAME = <span class="st">&quot;_id&quot;</span></a>
<a class="sourceLine" id="cb7-18" data-line-number="18"></a>
<a class="sourceLine" id="cb7-19" data-line-number="19">  <span class="kw">var</span> mongoClient: MongoClient = _</a>
<a class="sourceLine" id="cb7-20" data-line-number="20">  <span class="kw">var</span> database: MongoDatabase = _</a>
<a class="sourceLine" id="cb7-21" data-line-number="21">  <span class="kw">var</span> collection: MongoCollection[_] = _</a>
<a class="sourceLine" id="cb7-22" data-line-number="22"></a>
<a class="sourceLine" id="cb7-23" data-line-number="23">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">open</span>(partitionId: Long, version: Long): Boolean = {</a>
<a class="sourceLine" id="cb7-24" data-line-number="24">    mongoClient = <span class="fu">MongoClient</span>(connectionString)</a>
<a class="sourceLine" id="cb7-25" data-line-number="25">    database = mongoClient.<span class="fu">getDatabase</span>(databaseName)</a>
<a class="sourceLine" id="cb7-26" data-line-number="26">    collection = database.<span class="fu">getCollection</span>(collectionName)</a>
<a class="sourceLine" id="cb7-27" data-line-number="27">    <span class="kw">true</span></a>
<a class="sourceLine" id="cb7-28" data-line-number="28">  }</a>
<a class="sourceLine" id="cb7-29" data-line-number="29"></a>
<a class="sourceLine" id="cb7-30" data-line-number="30">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">getId</span>(obj: T) = {</a>
<a class="sourceLine" id="cb7-31" data-line-number="31">    <span class="kw">val</span> field = obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredField</span>(ID_FIELD_NAME)</a>
<a class="sourceLine" id="cb7-32" data-line-number="32">    field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb7-33" data-line-number="33">    field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb7-34" data-line-number="34">  }</a>
<a class="sourceLine" id="cb7-35" data-line-number="35"></a>
<a class="sourceLine" id="cb7-36" data-line-number="36">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">isPrimitive</span>(obj: AnyRef) =</a>
<a class="sourceLine" id="cb7-37" data-line-number="37">    obj.<span class="fu">isInstanceOf</span>[Int] ||</a>
<a class="sourceLine" id="cb7-38" data-line-number="38">      obj.<span class="fu">isInstanceOf</span>[String] ||</a>
<a class="sourceLine" id="cb7-39" data-line-number="39">      obj.<span class="fu">isInstanceOf</span>[Double] ||</a>
<a class="sourceLine" id="cb7-40" data-line-number="40">      obj.<span class="fu">isInstanceOf</span>[Float] ||</a>
<a class="sourceLine" id="cb7-41" data-line-number="41">      obj.<span class="fu">isInstanceOf</span>[Long] ||</a>
<a class="sourceLine" id="cb7-42" data-line-number="42">      obj.<span class="fu">isInstanceOf</span>[Short] ||</a>
<a class="sourceLine" id="cb7-43" data-line-number="43">      obj.<span class="fu">isInstanceOf</span>[Byte] ||</a>
<a class="sourceLine" id="cb7-44" data-line-number="44">      obj.<span class="fu">isInstanceOf</span>[Boolean] ||</a>
<a class="sourceLine" id="cb7-45" data-line-number="45">      obj.<span class="fu">isInstanceOf</span>[Char] ||</a>
<a class="sourceLine" id="cb7-46" data-line-number="46">      obj.<span class="fu">isInstanceOf</span>[List[_]] ||</a>
<a class="sourceLine" id="cb7-47" data-line-number="47">      obj.<span class="fu">isInstanceOf</span>[Map[_, _]]</a>
<a class="sourceLine" id="cb7-48" data-line-number="48"></a>
<a class="sourceLine" id="cb7-49" data-line-number="49">  <span class="kw">def</span> <span class="fu">getObjectFields</span>(path: String, obj: AnyRef): List[(String, AnyRef)] = {</a>
<a class="sourceLine" id="cb7-50" data-line-number="50">    <span class="kw">val</span> res = <span class="kw">new</span> ListBuffer[(String, AnyRef)]()</a>
<a class="sourceLine" id="cb7-51" data-line-number="51">    obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredFields</span>.<span class="fu">foreach</span>(field =&gt; {</a>
<a class="sourceLine" id="cb7-52" data-line-number="52">      field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb7-53" data-line-number="53">      <span class="kw">val</span> value = field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb7-54" data-line-number="54"></a>
<a class="sourceLine" id="cb7-55" data-line-number="55">      <span class="kw">if</span> (<span class="fu">isPrimitive</span>(value)) {</a>
<a class="sourceLine" id="cb7-56" data-line-number="56">        res += (path + field.<span class="fu">getName</span> -&gt; value)</a>
<a class="sourceLine" id="cb7-57" data-line-number="57">      } <span class="kw">else</span> {</a>
<a class="sourceLine" id="cb7-58" data-line-number="58">        res ++= <span class="fu">getObjectFields</span>(field.<span class="fu">getName</span> + <span class="st">&quot;.&quot;</span>, value)</a>
<a class="sourceLine" id="cb7-59" data-line-number="59">      }</a>
<a class="sourceLine" id="cb7-60" data-line-number="60">    })</a>
<a class="sourceLine" id="cb7-61" data-line-number="61">    res.<span class="fu">toList</span></a>
<a class="sourceLine" id="cb7-62" data-line-number="62">  }</a>
<a class="sourceLine" id="cb7-63" data-line-number="63"></a>
<a class="sourceLine" id="cb7-64" data-line-number="64">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">toSetQuery</span>(name: String, value: AnyRef) = <span class="fu">set</span>(name, value)</a>
<a class="sourceLine" id="cb7-65" data-line-number="65"></a>
<a class="sourceLine" id="cb7-66" data-line-number="66">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">toCombineQuery</span>(fields: List[(String, AnyRef)]) =</a>
<a class="sourceLine" id="cb7-67" data-line-number="67">    <span class="fu">combine</span>(fields.<span class="fu">filter</span>(f =&gt; f._<span class="dv">1</span> != ID_FIELD_NAME)</a>
<a class="sourceLine" id="cb7-68" data-line-number="68">      .<span class="fu">map</span>(f =&gt; <span class="fu">toSetQuery</span>(f._<span class="dv">1</span>, f._<span class="dv">2</span>)):_*)</a>
<a class="sourceLine" id="cb7-69" data-line-number="69"></a>
<a class="sourceLine" id="cb7-70" data-line-number="70">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">process</span>(value: T): Unit = {</a>
<a class="sourceLine" id="cb7-71" data-line-number="71">    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb7-72" data-line-number="72">      <span class="kw">val</span> options = <span class="kw">new</span> <span class="fu">UpdateOptions</span>().<span class="fu">upsert</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb7-73" data-line-number="73">      </a>
<a class="sourceLine" id="cb7-74" data-line-number="74">      <span class="kw">val</span> observable = collection.<span class="fu">updateOne</span>(</a>
<a class="sourceLine" id="cb7-75" data-line-number="75">        <span class="fu">equal</span>(<span class="st">&quot;_id&quot;</span>, <span class="fu">getId</span>(value)),</a>
<a class="sourceLine" id="cb7-76" data-line-number="76">        <span class="fu">toCombineQuery</span>(<span class="fu">getObjectFields</span>(<span class="st">&quot;&quot;</span>, value.<span class="fu">asInstanceOf</span>[AnyRef])),</a>
<a class="sourceLine" id="cb7-77" data-line-number="77">        options</a>
<a class="sourceLine" id="cb7-78" data-line-number="78">      )</a>
<a class="sourceLine" id="cb7-79" data-line-number="79">      Await.<span class="fu">result</span>(observable.<span class="fu">toFuture</span>(), Duration.<span class="fu">Inf</span>)</a>
<a class="sourceLine" id="cb7-80" data-line-number="80">    } <span class="kw">catch</span> {</a>
<a class="sourceLine" id="cb7-81" data-line-number="81">      <span class="kw">case</span> t: Throwable =&gt; <span class="fu">println</span>(t)</a>
<a class="sourceLine" id="cb7-82" data-line-number="82">    }</a>
<a class="sourceLine" id="cb7-83" data-line-number="83">  }</a>
<a class="sourceLine" id="cb7-84" data-line-number="84"></a>
<a class="sourceLine" id="cb7-85" data-line-number="85">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">close</span>(errorOrNull: Throwable): Unit = {</a>
<a class="sourceLine" id="cb7-86" data-line-number="86">    <span class="co">//do nothing</span></a>
<a class="sourceLine" id="cb7-87" data-line-number="87">  }</a>
<a class="sourceLine" id="cb7-88" data-line-number="88">}</a></code></pre>
    </div>
    <p>This can be used more easily, with a hierarchy of case classes, as long as the values in the case classes are
        the primitive types defined in the <code>isPrimitive</code> method (or the <code>isPrimitive</code> method can
        be extended):</p>
    <div class="sourceCode" id="cb8">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb8-1" data-line-number="1"><span class="kw">val</span> query = results</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">    .<span class="fu">writeStream</span></a>
<a class="sourceLine" id="cb8-3" data-line-number="3">    .<span class="fu">outputMode</span>(<span class="st">&quot;complete&quot;</span>)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    .<span class="fu">foreach</span>(</a>
<a class="sourceLine" id="cb8-5" data-line-number="5">      <span class="kw">new</span> MongoUpsertWriter[DeepMongoResult](<span class="st">&quot;mongodb://localhost:27017&quot;</span>, <span class="st">&quot;local&quot;</span>, <span class="st">&quot;results_collection&quot;</span>))</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">    .<span class="fu">start</span>()</a></code></pre>
    </div>
    <h2 id="generic-writer-based-on-generic-scala-collections">Generic Writer Based On Generic Scala Collections</h2>
    <p>A different way of looking at the problem would be to cosider the fact that any case class can be converted into
        a Map, a Scala structure that can be written to Mongo by the library without additional work. But for this we
        would need to convert a deep case class structure to a structure of Maps and Lists (or sequences) containing
        primitive (or at least non-case class) structures.</p>
    <p>The following experiment does just that:</p>
    <div class="sourceCode" id="cb9">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb9-2" data-line-number="2"></a>
<a class="sourceLine" id="cb9-3" data-line-number="3"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">CCMOne</span>(str: String, i: Int)</a>
<a class="sourceLine" id="cb9-4" data-line-number="4"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">CCMDeep</span>(str: String, o: CCMOne)</a>
<a class="sourceLine" id="cb9-5" data-line-number="5"><span class="kw">case</span> <span class="kw">class</span> <span class="fu">CCMDeepest</span>(str: String, cc: CCMDeep, m: Map[Int, CCMOne], l: List[CCMOne])</a>
<a class="sourceLine" id="cb9-6" data-line-number="6"></a>
<a class="sourceLine" id="cb9-7" data-line-number="7"><span class="kw">object</span> CaseClassToMap {</a>
<a class="sourceLine" id="cb9-8" data-line-number="8"></a>
<a class="sourceLine" id="cb9-9" data-line-number="9">  <span class="kw">def</span> <span class="fu">isCaseClass</span>(o: Any) =</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">    o.<span class="fu">getClass</span>.<span class="fu">getInterfaces</span>.<span class="fu">contains</span>(classOf[scala.<span class="fu">Product</span>])</a>
<a class="sourceLine" id="cb9-11" data-line-number="11"></a>
<a class="sourceLine" id="cb9-12" data-line-number="12">  <span class="kw">def</span> <span class="fu">unspoolSequence</span>(seq: Seq[_]): Seq[_] = </a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    seq.<span class="fu">map</span>(</a>
<a class="sourceLine" id="cb9-14" data-line-number="14">      v =&gt; <span class="fu">unspool</span>(v)</a>
<a class="sourceLine" id="cb9-15" data-line-number="15">    )</a>
<a class="sourceLine" id="cb9-16" data-line-number="16"></a>
<a class="sourceLine" id="cb9-17" data-line-number="17">  <span class="kw">def</span> <span class="fu">unspoolMap</span>(map: Map[_,_]): Map[_, _] =</a>
<a class="sourceLine" id="cb9-18" data-line-number="18">    map.<span class="fu">map</span>(</a>
<a class="sourceLine" id="cb9-19" data-line-number="19">      m =&gt; (m._<span class="dv">1</span>, <span class="fu">unspool</span>(m._<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb9-20" data-line-number="20">    )</a>
<a class="sourceLine" id="cb9-21" data-line-number="21"></a>
<a class="sourceLine" id="cb9-22" data-line-number="22">  <span class="kw">def</span> <span class="fu">unspoolCaseClass</span>(cc: Product): Map[String, Any] =</a>
<a class="sourceLine" id="cb9-23" data-line-number="23">    <span class="fu">unspoolMap</span>(</a>
<a class="sourceLine" id="cb9-24" data-line-number="24">        cc.<span class="fu">getClass</span>.<span class="fu">getDeclaredFields</span></a>
<a class="sourceLine" id="cb9-25" data-line-number="25">            .<span class="fu">map</span>(_.<span class="fu">getName</span>)</a>
<a class="sourceLine" id="cb9-26" data-line-number="26">            .<span class="fu">zip</span>(cc.<span class="fu">productIterator</span>.<span class="fu">to</span>)</a>
<a class="sourceLine" id="cb9-27" data-line-number="27">            .<span class="fu">toMap</span></a>
<a class="sourceLine" id="cb9-28" data-line-number="28">    ).<span class="fu">asInstanceOf</span>[Map[String, Any]]</a>
<a class="sourceLine" id="cb9-29" data-line-number="29"></a>
<a class="sourceLine" id="cb9-30" data-line-number="30">  <span class="kw">def</span> <span class="fu">unspool</span>(v: Any) =</a>
<a class="sourceLine" id="cb9-31" data-line-number="31">    <span class="kw">if</span> (<span class="fu">isCaseClass</span>(v)) <span class="fu">unspoolCaseClass</span>(v.<span class="fu">asInstanceOf</span>[Product])</a>
<a class="sourceLine" id="cb9-32" data-line-number="32">    <span class="kw">else</span> <span class="kw">if</span> (v.<span class="fu">isInstanceOf</span>[Seq[_]]) <span class="fu">unspoolSequence</span>(v.<span class="fu">asInstanceOf</span>[Seq[_]])</a>
<a class="sourceLine" id="cb9-33" data-line-number="33">    <span class="kw">else</span> <span class="kw">if</span> (v.<span class="fu">isInstanceOf</span>[Map[_,_]]) <span class="fu">unspoolMap</span>(v.<span class="fu">asInstanceOf</span>[Map[_, _]])</a>
<a class="sourceLine" id="cb9-34" data-line-number="34">    <span class="kw">else</span> v</a>
<a class="sourceLine" id="cb9-35" data-line-number="35"></a>
<a class="sourceLine" id="cb9-36" data-line-number="36">  <span class="kw">def</span> <span class="fu">main</span>(args: Array[String]): Unit = {</a>
<a class="sourceLine" id="cb9-37" data-line-number="37">    <span class="fu">println</span>(<span class="fu">isCaseClass</span>(<span class="fu">CCMOne</span>(<span class="st">&quot;one&quot;</span>, <span class="dv">1</span>)))</a>
<a class="sourceLine" id="cb9-38" data-line-number="38">    <span class="fu">println</span>(<span class="fu">isCaseClass</span>(<span class="fl">1.</span>asInstanceOf[AnyRef]))</a>
<a class="sourceLine" id="cb9-39" data-line-number="39">    <span class="fu">println</span>(<span class="fu">isCaseClass</span>(<span class="st">&quot;test&quot;</span>))</a>
<a class="sourceLine" id="cb9-40" data-line-number="40">    <span class="fu">println</span>(<span class="fu">isCaseClass</span>(List))</a>
<a class="sourceLine" id="cb9-41" data-line-number="41"></a>
<a class="sourceLine" id="cb9-42" data-line-number="42">    <span class="fu">println</span>(<span class="fu">unspool</span>(<span class="fu">CCMOne</span>(<span class="st">&quot;two&quot;</span>, <span class="dv">2</span>)))</a>
<a class="sourceLine" id="cb9-43" data-line-number="43">    <span class="fu">println</span>(<span class="fu">unspool</span>(<span class="fu">CCMDeep</span>(<span class="st">&quot;ccmd&quot;</span>, <span class="fu">CCMOne</span>(<span class="st">&quot;three&quot;</span>, <span class="dv">3</span>))))</a>
<a class="sourceLine" id="cb9-44" data-line-number="44">    <span class="fu">println</span>(<span class="fu">unspool</span>(<span class="fu">CCMDeepest</span>(</a>
<a class="sourceLine" id="cb9-45" data-line-number="45">      <span class="st">&quot;ccmddd&quot;</span>,</a>
<a class="sourceLine" id="cb9-46" data-line-number="46">      <span class="fu">CCMDeep</span>(<span class="st">&quot;ccmd2&quot;</span>, <span class="fu">CCMOne</span>(<span class="st">&quot;four&quot;</span>, <span class="dv">4</span>)),</a>
<a class="sourceLine" id="cb9-47" data-line-number="47">      Map(</a>
<a class="sourceLine" id="cb9-48" data-line-number="48">        <span class="dv">1</span> -&gt; <span class="fu">CCMOne</span>(<span class="st">&quot;five&quot;</span>, <span class="dv">5</span>),</a>
<a class="sourceLine" id="cb9-49" data-line-number="49">        <span class="dv">2</span> -&gt; <span class="fu">CCMOne</span>(<span class="st">&quot;six&quot;</span>, <span class="dv">6</span>)</a>
<a class="sourceLine" id="cb9-50" data-line-number="50">      ),</a>
<a class="sourceLine" id="cb9-51" data-line-number="51">      List(<span class="fu">CCMOne</span>(<span class="st">&quot;seven&quot;</span>, <span class="dv">7</span>))</a>
<a class="sourceLine" id="cb9-52" data-line-number="52">    )))</a>
<a class="sourceLine" id="cb9-53" data-line-number="53">  }</a>
<a class="sourceLine" id="cb9-54" data-line-number="54">}</a></code></pre>
    </div>
    <ul>
        <li>we first have a method that lets us identify case classes, <code>isCaseClass</code>, based on wether the
            object has the <code>Product</code> interface or not</li>
        <li>we then have an <code>unspool</code> method that converts our object into a standard scala structure (map
            or sequence) by delegating to more granular unspool methods; it does this by checking if we are dealing
            with an instance of a case class, an instance of a sequence or an instance of a map; if none are found, the
            method just returns the value</li>
        <li><code>unspoolCaseClass</code> takes each field of the case class and returns a map containing the field
            name and the unspooled value of the field</li>
        <li><code>unspoolSequence</code> will go over all values in a sequence and try to unspool them</li>
        <li><code>unspoolMap</code> will go over all values in a map and try to unspool them (keys are assumed to be a
            data type that can be written to Mongo easily, but that may not always be the case, so more work should be
            done to handle this)</li>
        <li>there may be some type casting in the above code that may turn out to be unsafe and more investigation is
            necessary to make sure all of it is ok</li>
    </ul>
    <p>Running all that code you should get the following output:</p>
    <pre><code>true
false
false
false
Map(str -&gt; two, i -&gt; 2)
Map(str -&gt; ccmd, o -&gt; Map(str -&gt; three, i -&gt; 3))
Map(str -&gt; ccmddd, cc -&gt; Map(str -&gt; ccmd2, o -&gt; Map(str -&gt; four, i -&gt; 4)), m -&gt; Map(1 -&gt; Map(str -&gt; five, i -&gt; 5), 2 -&gt; Map(str -&gt; six, i -&gt; 6)), l -&gt; List(Map(str -&gt; seven, i -&gt; 7)))</code></pre>
    <p>The Mongo writer can now be implemented as follows:</p>
    <div class="sourceCode" id="cb11">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb11-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">bigdata</span></a>
<a class="sourceLine" id="cb11-2" data-line-number="2"></a>
<a class="sourceLine" id="cb11-3" data-line-number="3"><span class="kw">import</span> com.<span class="fu">mongodb</span>.<span class="fu">client</span>.<span class="fu">model</span>.<span class="fu">ReplaceOptions</span></a>
<a class="sourceLine" id="cb11-4" data-line-number="4"><span class="kw">import</span> org.<span class="fu">apache</span>.<span class="fu">spark</span>.<span class="fu">sql</span>.<span class="fu">ForeachWriter</span></a>
<a class="sourceLine" id="cb11-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>._</a>
<a class="sourceLine" id="cb11-6" data-line-number="6"><span class="kw">import</span> org.<span class="fu">mongodb</span>.<span class="fu">scala</span>.<span class="fu">model</span>.<span class="fu">Filters</span>._</a>
<a class="sourceLine" id="cb11-7" data-line-number="7"></a>
<a class="sourceLine" id="cb11-8" data-line-number="8"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">Await</span></a>
<a class="sourceLine" id="cb11-9" data-line-number="9"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>.<span class="fu">Duration</span></a>
<a class="sourceLine" id="cb11-10" data-line-number="10"></a>
<a class="sourceLine" id="cb11-11" data-line-number="11"><span class="kw">class</span> MongoUpsertWriter[T](connectionString: String,</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">                           databaseName: String,</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">                           collectionName: String) <span class="kw">extends</span> ForeachWriter[T] {</a>
<a class="sourceLine" id="cb11-14" data-line-number="14"></a>
<a class="sourceLine" id="cb11-15" data-line-number="15">  <span class="kw">private</span> <span class="kw">val</span> ID_FIELD_NAME = <span class="st">&quot;_id&quot;</span></a>
<a class="sourceLine" id="cb11-16" data-line-number="16"></a>
<a class="sourceLine" id="cb11-17" data-line-number="17">  <span class="kw">var</span> mongoClient: MongoClient = _</a>
<a class="sourceLine" id="cb11-18" data-line-number="18">  <span class="kw">var</span> database: MongoDatabase = _</a>
<a class="sourceLine" id="cb11-19" data-line-number="19">  <span class="kw">var</span> collection: MongoCollection[Map[_,_]] = _</a>
<a class="sourceLine" id="cb11-20" data-line-number="20"></a>
<a class="sourceLine" id="cb11-21" data-line-number="21">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">open</span>(partitionId: Long, version: Long): Boolean = {</a>
<a class="sourceLine" id="cb11-22" data-line-number="22">    mongoClient = <span class="fu">MongoClient</span>(connectionString)</a>
<a class="sourceLine" id="cb11-23" data-line-number="23">    database = mongoClient.<span class="fu">getDatabase</span>(databaseName)</a>
<a class="sourceLine" id="cb11-24" data-line-number="24">    collection = database.<span class="fu">getCollection</span>(collectionName)</a>
<a class="sourceLine" id="cb11-25" data-line-number="25">    <span class="kw">true</span></a>
<a class="sourceLine" id="cb11-26" data-line-number="26">  }</a>
<a class="sourceLine" id="cb11-27" data-line-number="27"></a>
<a class="sourceLine" id="cb11-28" data-line-number="28">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">getId</span>(obj: T) = {</a>
<a class="sourceLine" id="cb11-29" data-line-number="29">    <span class="kw">val</span> field = obj.<span class="fu">getClass</span>.<span class="fu">getDeclaredField</span>(ID_FIELD_NAME)</a>
<a class="sourceLine" id="cb11-30" data-line-number="30">    field setAccessible <span class="kw">true</span></a>
<a class="sourceLine" id="cb11-31" data-line-number="31">    field.<span class="fu">get</span>(obj)</a>
<a class="sourceLine" id="cb11-32" data-line-number="32">  }</a>
<a class="sourceLine" id="cb11-33" data-line-number="33"></a>
<a class="sourceLine" id="cb11-34" data-line-number="34">  <span class="kw">def</span> <span class="fu">isCaseClass</span>(o: Any) =</a>
<a class="sourceLine" id="cb11-35" data-line-number="35">    o.<span class="fu">getClass</span>.<span class="fu">getInterfaces</span>.<span class="fu">contains</span>(classOf[scala.<span class="fu">Product</span>])</a>
<a class="sourceLine" id="cb11-36" data-line-number="36"></a>
<a class="sourceLine" id="cb11-37" data-line-number="37">  <span class="kw">def</span> <span class="fu">unspoolSequence</span>(seq: Seq[_]): Seq[_] =</a>
<a class="sourceLine" id="cb11-38" data-line-number="38">    seq.<span class="fu">map</span>(</a>
<a class="sourceLine" id="cb11-39" data-line-number="39">      v =&gt; <span class="fu">unspool</span>(v)</a>
<a class="sourceLine" id="cb11-40" data-line-number="40">    )</a>
<a class="sourceLine" id="cb11-41" data-line-number="41"></a>
<a class="sourceLine" id="cb11-42" data-line-number="42">  <span class="kw">def</span> <span class="fu">unspoolMap</span>(map: Map[_,_]): Map[_, _] =</a>
<a class="sourceLine" id="cb11-43" data-line-number="43">    map.<span class="fu">map</span>(</a>
<a class="sourceLine" id="cb11-44" data-line-number="44">      m =&gt; (m._<span class="dv">1</span>, <span class="fu">unspool</span>(m._<span class="dv">2</span>))</a>
<a class="sourceLine" id="cb11-45" data-line-number="45">    )</a>
<a class="sourceLine" id="cb11-46" data-line-number="46"></a>
<a class="sourceLine" id="cb11-47" data-line-number="47">  <span class="kw">def</span> <span class="fu">unspoolCaseClass</span>(cc: Product): Map[String, Any] =</a>
<a class="sourceLine" id="cb11-48" data-line-number="48">    <span class="fu">unspoolMap</span>(cc.<span class="fu">getClass</span>.<span class="fu">getDeclaredFields</span></a>
<a class="sourceLine" id="cb11-49" data-line-number="49">      .<span class="fu">map</span>( _.<span class="fu">getName</span> )</a>
<a class="sourceLine" id="cb11-50" data-line-number="50">      .<span class="fu">zip</span>( cc.<span class="fu">productIterator</span>.<span class="fu">to</span> )</a>
<a class="sourceLine" id="cb11-51" data-line-number="51">      .<span class="fu">toMap</span>).<span class="fu">asInstanceOf</span>[Map[String, Any]]</a>
<a class="sourceLine" id="cb11-52" data-line-number="52"></a>
<a class="sourceLine" id="cb11-53" data-line-number="53">  <span class="kw">def</span> <span class="fu">unspool</span>(v: Any) =</a>
<a class="sourceLine" id="cb11-54" data-line-number="54">    <span class="kw">if</span> (<span class="fu">isCaseClass</span>(v)) <span class="fu">unspoolCaseClass</span>(v.<span class="fu">asInstanceOf</span>[Product])</a>
<a class="sourceLine" id="cb11-55" data-line-number="55">    <span class="kw">else</span> <span class="kw">if</span> (v.<span class="fu">isInstanceOf</span>[Seq[_]]) <span class="fu">unspoolSequence</span>(v.<span class="fu">asInstanceOf</span>[Seq[_]])</a>
<a class="sourceLine" id="cb11-56" data-line-number="56">    <span class="kw">else</span> <span class="kw">if</span> (v.<span class="fu">isInstanceOf</span>[Map[_,_]]) <span class="fu">unspoolMap</span>(v.<span class="fu">asInstanceOf</span>[Map[_, _]])</a>
<a class="sourceLine" id="cb11-57" data-line-number="57">    <span class="kw">else</span> v</a>
<a class="sourceLine" id="cb11-58" data-line-number="58"></a>
<a class="sourceLine" id="cb11-59" data-line-number="59">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">process</span>(value: T): Unit = {</a>
<a class="sourceLine" id="cb11-60" data-line-number="60">    <span class="kw">try</span> {</a>
<a class="sourceLine" id="cb11-61" data-line-number="61">      <span class="kw">val</span> options = <span class="kw">new</span> <span class="fu">ReplaceOptions</span>().<span class="fu">upsert</span>(<span class="kw">true</span>)</a>
<a class="sourceLine" id="cb11-62" data-line-number="62"></a>
<a class="sourceLine" id="cb11-63" data-line-number="63">      <span class="kw">val</span> observable = collection.<span class="fu">replaceOne</span>(</a>
<a class="sourceLine" id="cb11-64" data-line-number="64">        <span class="fu">equal</span>(<span class="st">&quot;_id&quot;</span>, <span class="fu">getId</span>(value)),</a>
<a class="sourceLine" id="cb11-65" data-line-number="65">        <span class="fu">unspool</span>(value).<span class="fu">asInstanceOf</span>[Map[_,_]],</a>
<a class="sourceLine" id="cb11-66" data-line-number="66">        options</a>
<a class="sourceLine" id="cb11-67" data-line-number="67">      )</a>
<a class="sourceLine" id="cb11-68" data-line-number="68">      Await.<span class="fu">result</span>(observable.<span class="fu">toFuture</span>(), Duration.<span class="fu">Inf</span>)</a>
<a class="sourceLine" id="cb11-69" data-line-number="69">    } <span class="kw">catch</span> {</a>
<a class="sourceLine" id="cb11-70" data-line-number="70">      <span class="kw">case</span> t: Throwable =&gt; <span class="fu">println</span>(t)</a>
<a class="sourceLine" id="cb11-71" data-line-number="71">    }</a>
<a class="sourceLine" id="cb11-72" data-line-number="72">  }</a>
<a class="sourceLine" id="cb11-73" data-line-number="73"></a>
<a class="sourceLine" id="cb11-74" data-line-number="74">  <span class="kw">override</span> <span class="kw">def</span> <span class="fu">close</span>(errorOrNull: Throwable): Unit = {</a>
<a class="sourceLine" id="cb11-75" data-line-number="75">    <span class="co">//do nothing</span></a>
<a class="sourceLine" id="cb11-76" data-line-number="76">  }</a>
<a class="sourceLine" id="cb11-77" data-line-number="77">}</a></code></pre>
    </div>
    <p>Notice that we no longer use <em>set</em> queries, instead we use the <code>replaceOne</code> method, with
        upsert configured, to just save the map to Mongo. This will result in a structure in Mongo that is exactly the
        same as the structure saved by the first sollution (full-featured sollution).</p>
    <p>This writer can be instantiated in the same way as previous ones:</p>
    <div class="sourceCode" id="cb12">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">val</span> query = results</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">    .<span class="fu">writeStream</span></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">    .<span class="fu">outputMode</span>(<span class="st">&quot;complete&quot;</span>)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    .<span class="fu">foreach</span>(</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">      <span class="kw">new</span> MongoUpsertWriter[DeepMongoResult](<span class="st">&quot;mongodb://localhost:27017&quot;</span>, <span class="st">&quot;local&quot;</span>, <span class="st">&quot;results_collection&quot;</span>))</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">    .<span class="fu">start</span>()</a></code></pre>
    </div>
</body>