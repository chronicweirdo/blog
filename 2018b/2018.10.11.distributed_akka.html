<!DOCTYPE html>
<html>

<head>
    <meta http-equiv="content-type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="How to make a project scale seamlessly across machines, and share work, with Akka Cluster.">

    <title>Distributed Akka Deployment</title>
    <link rel="shortcut icon" type="image/x-icon" href="../favicon.ico?">

    <link id="theme" rel="stylesheet" type="text/css" href="main.css">
    <link id="theme" rel="stylesheet" type="text/css" href="code.css">
</head>

<body>
    <p class="header">
        <a class="home" href="../index.html">home</a>
        <span>/</span>
        <span class="date">2018.10.11 21:30</span>
        <span>/</span><span class="tag">scala</span>
        <span>/</span><span class="tag">akka</span>
        <span>/</span><span class="tag">cluster</span>
        <span>/</span><span class="tag">spring</span>
    </p>
    <h1 id="distributed-akka-deployment">Distributed Akka Deployment</h1>
    <p>This posting will explore the configuration necessary to run an Akka system distributed across multiple
        machines.</p>
    <h2 id="example-application">Example Application</h2>
    <p>We’ll need a program that simulates a master actor starting one or more worker actors and periodically sending
        them work to do. We’ll also need a way to simulate the worker actors doing an expensive job (one that takes
        some amount of time). Once we have all this, we’ll look into how the system behaves, how we create more worker
        actors locally to improve the performance of the app, and finally how we can run this app on multiple
        processes/machines and how parallelization works in those conditions.</p>
    <p>As with previous example, I am using Gradle and Spring Boot to build the project (but will look into SBT and a
        lighter/scala-focused build environment in a future investigation). The <code>build.gradle</code> file is
        listed below:</p>
    <pre class="groovy"><code>buildscript {
    ext {
        springBootVersion = &#39;2.0.5.RELEASE&#39;
    }
    repositories {
        mavenCentral()
    }
    dependencies {
        classpath(&quot;org.springframework.boot:spring-boot-gradle-plugin:${springBootVersion}&quot;)
    }
}

apply plugin: &#39;java&#39;
apply plugin: &#39;scala&#39;
apply plugin: &#39;eclipse&#39;
apply plugin: &#39;org.springframework.boot&#39;
apply plugin: &#39;io.spring.dependency-management&#39;

group = &#39;com.cacoveanu.akka&#39;
version = &#39;0.0.1-SNAPSHOT&#39;
sourceCompatibility = 1.8

sourceSets.main.scala.srcDir &quot;src/main/java&quot;
sourceSets.main.java.srcDirs = []
sourceSets.test.scala.srcDir &quot;src/test/java&quot;
sourceSets.test.java.srcDirs = []

configurations {
    scalaCompilerPlugins { transitive = false }
}

repositories {
    mavenCentral()
}

dependencies {
    implementation(&#39;org.scala-lang:scala-library:2.12.5&#39;)
    implementation(&#39;org.springframework.boot:spring-boot-starter-web&#39;)
    compile(&#39;com.typesafe.akka:akka-actor_2.12:2.5.11&#39;)
    testImplementation(&#39;org.springframework.boot:spring-boot-starter-test&#39;)
}</code></pre>
    <p>When we start the Spring Application, we also create the actor system and the master actor through the Spring
        configuration:</p>
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb2-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">akka</span>.<span class="fu">distributed</span></a>
<a class="sourceLine" id="cb2-2" data-line-number="2"></a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="kw">import</span> org.<span class="fu">springframework</span>.<span class="fu">boot</span>.<span class="fu">SpringApplication</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4"><span class="kw">import</span> org.<span class="fu">springframework</span>.<span class="fu">boot</span>.<span class="fu">autoconfigure</span>.<span class="fu">SpringBootApplication</span></a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">springframework</span>.<span class="fu">context</span>.<span class="fu">annotation</span>.<span class="fu">Bean</span></a>
<a class="sourceLine" id="cb2-6" data-line-number="6"><span class="kw">import</span> akka.<span class="fu">actor</span>.{ActorRef, ActorSystem, Props}</a>
<a class="sourceLine" id="cb2-7" data-line-number="7"><span class="kw">import</span> com.<span class="fu">cacoveanu</span>.<span class="fu">akka</span>.<span class="fu">distributed</span>.<span class="fu">actors</span>.{MasterActor, WorkerActor}</a>
<a class="sourceLine" id="cb2-8" data-line-number="8"></a>
<a class="sourceLine" id="cb2-9" data-line-number="9">@SpringBootApplication</a>
<a class="sourceLine" id="cb2-10" data-line-number="10"><span class="kw">class</span> Configuration {</a>
<a class="sourceLine" id="cb2-11" data-line-number="11"></a>
<a class="sourceLine" id="cb2-12" data-line-number="12">  @Bean</a>
<a class="sourceLine" id="cb2-13" data-line-number="13">  <span class="kw">def</span> <span class="fu">createActorsSystem</span>(): ActorSystem = {</a>
<a class="sourceLine" id="cb2-14" data-line-number="14">    <span class="fu">ActorSystem</span>(<span class="st">&quot;distributedSystem&quot;</span>)</a>
<a class="sourceLine" id="cb2-15" data-line-number="15">  }</a>
<a class="sourceLine" id="cb2-16" data-line-number="16"></a>
<a class="sourceLine" id="cb2-17" data-line-number="17">  @<span class="fu">Bean</span>(Array(<span class="st">&quot;masterActor&quot;</span>))</a>
<a class="sourceLine" id="cb2-18" data-line-number="18">  <span class="kw">def</span> <span class="fu">createMasterActor</span>(actorSystem: ActorSystem): ActorRef = {</a>
<a class="sourceLine" id="cb2-19" data-line-number="19">    actorSystem.<span class="fu">actorOf</span>(Props.<span class="fu">create</span>(classOf[MasterActor]), <span class="st">&quot;masterActor&quot;</span>)</a>
<a class="sourceLine" id="cb2-20" data-line-number="20">  }</a>
<a class="sourceLine" id="cb2-21" data-line-number="21"></a>
<a class="sourceLine" id="cb2-22" data-line-number="22">}</a>
<a class="sourceLine" id="cb2-23" data-line-number="23"></a>
<a class="sourceLine" id="cb2-24" data-line-number="24"><span class="kw">object</span> DistributedApplication {</a>
<a class="sourceLine" id="cb2-25" data-line-number="25"></a>
<a class="sourceLine" id="cb2-26" data-line-number="26">  <span class="kw">def</span> <span class="fu">main</span>(args: Array[String]): Unit = {</a>
<a class="sourceLine" id="cb2-27" data-line-number="27">    SpringApplication.<span class="fu">run</span>(classOf[Configuration])</a>
<a class="sourceLine" id="cb2-28" data-line-number="28">  }</a>
<a class="sourceLine" id="cb2-29" data-line-number="29"></a>
<a class="sourceLine" id="cb2-30" data-line-number="30">}</a></code></pre>
    <p>In our master actor we use timers to introduce a pause between processing batches. As soon as the processing is
        done with one batch, we schedule the start of the next batch. Batches of data that need to be processed are
        created randomly. At first, we will only create one worker actor that our master communicates with. We also
        monitor how much time it takes for each batch to get processed. As we parallelize this process we can expect
        the processing time to decrease.</p>
    <div class="sourceCode" id="cb3">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb3-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">akka</span>.<span class="fu">distributed</span>.<span class="fu">actors</span></a>
<a class="sourceLine" id="cb3-2" data-line-number="2"></a>
<a class="sourceLine" id="cb3-3" data-line-number="3"><span class="kw">import</span> akka.<span class="fu">actor</span>.{Actor, Timers}</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="kw">import</span> com.<span class="fu">cacoveanu</span>.<span class="fu">akka</span>.<span class="fu">distributed</span>.<span class="fu">actors</span>.<span class="fu">WorkerActor</span>.{Result, WorkOn}</a>
<a class="sourceLine" id="cb3-5" data-line-number="5"><span class="kw">import</span> org.<span class="fu">slf4j</span>.<span class="fu">LoggerFactory</span></a>
<a class="sourceLine" id="cb3-6" data-line-number="6"></a>
<a class="sourceLine" id="cb3-7" data-line-number="7"><span class="kw">import</span> scala.<span class="fu">concurrent</span>.<span class="fu">duration</span>._</a>
<a class="sourceLine" id="cb3-8" data-line-number="8"><span class="kw">import</span> scala.<span class="fu">util</span>.<span class="fu">Random</span></a>
<a class="sourceLine" id="cb3-9" data-line-number="9"></a>
<a class="sourceLine" id="cb3-10" data-line-number="10"><span class="kw">object</span> MasterActor {</a>
<a class="sourceLine" id="cb3-11" data-line-number="11">  <span class="kw">case</span> <span class="kw">object</span> Start</a>
<a class="sourceLine" id="cb3-12" data-line-number="12">  <span class="kw">case</span> <span class="kw">object</span> ScheduleRestart</a>
<a class="sourceLine" id="cb3-13" data-line-number="13">}</a>
<a class="sourceLine" id="cb3-14" data-line-number="14"></a>
<a class="sourceLine" id="cb3-15" data-line-number="15"><span class="kw">class</span> MasterActor <span class="kw">extends</span> Actor <span class="kw">with</span> Timers {</a>
<a class="sourceLine" id="cb3-16" data-line-number="16">  <span class="kw">import</span> MasterActor._</a>
<a class="sourceLine" id="cb3-17" data-line-number="17"></a>
<a class="sourceLine" id="cb3-18" data-line-number="18">  <span class="kw">private</span> <span class="kw">val</span> logger = LoggerFactory.<span class="fu">getLogger</span>(classOf[MasterActor])</a>
<a class="sourceLine" id="cb3-19" data-line-number="19"></a>
<a class="sourceLine" id="cb3-20" data-line-number="20">  timers.<span class="fu">startSingleTimer</span>(<span class="st">&quot;start&quot;</span>, Start, <span class="dv">500</span> millis)</a>
<a class="sourceLine" id="cb3-21" data-line-number="21"></a>
<a class="sourceLine" id="cb3-22" data-line-number="22">  <span class="kw">private</span> <span class="kw">var</span> startTime = 0L</a>
<a class="sourceLine" id="cb3-23" data-line-number="23">  <span class="kw">private</span> <span class="kw">var</span> runningJobs = <span class="dv">0</span></a>
<a class="sourceLine" id="cb3-24" data-line-number="24"></a>
<a class="sourceLine" id="cb3-25" data-line-number="25">  <span class="kw">private</span> <span class="kw">val</span> worker = context.<span class="fu">actorOf</span>(WorkerActor.<span class="fu">props</span>(<span class="dv">500</span>))</a>
<a class="sourceLine" id="cb3-26" data-line-number="26"></a>
<a class="sourceLine" id="cb3-27" data-line-number="27">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">getDataToProcess</span>(): Iterable[String] =</a>
<a class="sourceLine" id="cb3-28" data-line-number="28">    <span class="co">//Seq.fill(1 + Random.nextInt(20))(System.nanoTime).map(l =&gt; l.toString)</span></a>
<a class="sourceLine" id="cb3-29" data-line-number="29">    Seq.<span class="fu">fill</span>(<span class="dv">20</span>)(System.<span class="fu">nanoTime</span>).<span class="fu">map</span>(l =&gt; l.<span class="fu">toString</span>)</a>
<a class="sourceLine" id="cb3-30" data-line-number="30"></a>
<a class="sourceLine" id="cb3-31" data-line-number="31">  <span class="kw">override</span> <span class="kw">def</span> receive: Receive = {</a>
<a class="sourceLine" id="cb3-32" data-line-number="32">    <span class="kw">case</span> Start =&gt;</a>
<a class="sourceLine" id="cb3-33" data-line-number="33">      <span class="kw">val</span> data = <span class="fu">getDataToProcess</span>()</a>
<a class="sourceLine" id="cb3-34" data-line-number="34">      runningJobs = data.<span class="fu">size</span></a>
<a class="sourceLine" id="cb3-35" data-line-number="35">      logger.<span class="fu">info</span>(s<span class="st">&quot;starting $runningJobs jobs&quot;</span>)</a>
<a class="sourceLine" id="cb3-36" data-line-number="36">      <span class="kw">if</span> (runningJobs &gt; <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb3-37" data-line-number="37">        startTime = System.<span class="fu">currentTimeMillis</span>()</a>
<a class="sourceLine" id="cb3-38" data-line-number="38">        data.<span class="fu">foreach</span>(m =&gt; worker ! <span class="fu">WorkOn</span>(m))</a>
<a class="sourceLine" id="cb3-39" data-line-number="39">      }</a>
<a class="sourceLine" id="cb3-40" data-line-number="40">      <span class="kw">else</span> self ! ScheduleRestart</a>
<a class="sourceLine" id="cb3-41" data-line-number="41"></a>
<a class="sourceLine" id="cb3-42" data-line-number="42">    <span class="kw">case</span> Result(message) =&gt;</a>
<a class="sourceLine" id="cb3-43" data-line-number="43">      logger.<span class="fu">info</span>(s<span class="st">&quot;done work, result: $message&quot;</span>)</a>
<a class="sourceLine" id="cb3-44" data-line-number="44">      runningJobs = runningJobs - <span class="dv">1</span></a>
<a class="sourceLine" id="cb3-45" data-line-number="45">      <span class="kw">if</span> (runningJobs == <span class="dv">0</span>) self ! ScheduleRestart</a>
<a class="sourceLine" id="cb3-46" data-line-number="46"></a>
<a class="sourceLine" id="cb3-47" data-line-number="47">    <span class="kw">case</span> ScheduleRestart =&gt;</a>
<a class="sourceLine" id="cb3-48" data-line-number="48">      logger.<span class="fu">info</span>(s<span class="st">&quot;processing of the batch took ${System.currentTimeMillis() - startTime} milliseconds&quot;</span>)</a>
<a class="sourceLine" id="cb3-49" data-line-number="49">      logger.<span class="fu">info</span>(<span class="st">&quot;schedulling master actor restart&quot;</span>)</a>
<a class="sourceLine" id="cb3-50" data-line-number="50">      timers.<span class="fu">startSingleTimer</span>(<span class="st">&quot;start again&quot;</span>, Start, <span class="dv">500</span> millis)</a>
<a class="sourceLine" id="cb3-51" data-line-number="51">  }</a>
<a class="sourceLine" id="cb3-52" data-line-number="52">}</a></code></pre>
    </div>
    <p>In the worker actor we simulate long-lasting operations by puttin the thread to sleep. Once the work is done, we
        send the result message back to the master. The pause of the worker is configurable.</p>
    <div class="sourceCode" id="cb4">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb4-1" data-line-number="1"><span class="kw">package</span> com.<span class="fu">cacoveanu</span>.<span class="fu">akka</span>.<span class="fu">distributed</span>.<span class="fu">actors</span></a>
<a class="sourceLine" id="cb4-2" data-line-number="2"></a>
<a class="sourceLine" id="cb4-3" data-line-number="3"><span class="kw">import</span> akka.<span class="fu">actor</span>.{Actor, Props, Timers}</a>
<a class="sourceLine" id="cb4-4" data-line-number="4"></a>
<a class="sourceLine" id="cb4-5" data-line-number="5"><span class="kw">object</span> WorkerActor {</a>
<a class="sourceLine" id="cb4-6" data-line-number="6">  <span class="kw">def</span> <span class="fu">props</span>(pause: Long): Props = <span class="fu">Props</span>(<span class="kw">new</span> <span class="fu">WorkerActor</span>(pause))</a>
<a class="sourceLine" id="cb4-7" data-line-number="7"></a>
<a class="sourceLine" id="cb4-8" data-line-number="8">  <span class="kw">case</span> <span class="kw">class</span> <span class="fu">WorkOn</span>(message: String)</a>
<a class="sourceLine" id="cb4-9" data-line-number="9">  <span class="kw">case</span> <span class="kw">class</span> Result(message: String)</a>
<a class="sourceLine" id="cb4-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb4-11" data-line-number="11"></a>
<a class="sourceLine" id="cb4-12" data-line-number="12"><span class="kw">class</span> <span class="fu">WorkerActor</span>(<span class="kw">val</span> pause: Long) <span class="kw">extends</span> Actor <span class="kw">with</span> Timers {</a>
<a class="sourceLine" id="cb4-13" data-line-number="13">  <span class="kw">import</span> WorkerActor._</a>
<a class="sourceLine" id="cb4-14" data-line-number="14"></a>
<a class="sourceLine" id="cb4-15" data-line-number="15">  <span class="kw">private</span> <span class="kw">def</span> <span class="fu">process</span>(message: String): String = {</a>
<a class="sourceLine" id="cb4-16" data-line-number="16">    Thread.<span class="fu">sleep</span>(pause)</a>
<a class="sourceLine" id="cb4-17" data-line-number="17">    message + <span class="st">&quot; done&quot;</span></a>
<a class="sourceLine" id="cb4-18" data-line-number="18">  }</a>
<a class="sourceLine" id="cb4-19" data-line-number="19"></a>
<a class="sourceLine" id="cb4-20" data-line-number="20">  <span class="kw">override</span> <span class="kw">def</span> receive: Receive = {</a>
<a class="sourceLine" id="cb4-21" data-line-number="21">    <span class="kw">case</span> <span class="fu">WorkOn</span>(message) =&gt; sender ! Result(<span class="fu">process</span>(message))</a>
<a class="sourceLine" id="cb4-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb4-23" data-line-number="23">}</a></code></pre>
    </div>
    <p>Running the above program, we’ll see that we get similar run times outputted to the logs for each batch of 20
        jobs:</p>
    <pre><code>starting 20 jobs
...
processing of the batch took 10024 milliseconds
schedulling master actor restart
starting 20 jobs
...
processing of the batch took 10056 milliseconds
schedulling master actor restart
starting 20 jobs
...
processing of the batch took 10063 milliseconds</code></pre>
    <h2 id="local-parallelization">Local Parallelization</h2>
    <p>In Akka, parallelization of operations can be achieved simply by increasing the number of actors handling that
        work. In our case we will create a pool of 4 worker actors, instead of a single worker actors, with the
        following change in the master actor:</p>
    <div class="sourceCode" id="cb6">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb6-1" data-line-number="1"><span class="kw">private</span> <span class="kw">val</span> worker = context.<span class="fu">actorOf</span>(</a>
<a class="sourceLine" id="cb6-2" data-line-number="2">  <span class="fu">RoundRobinPool</span>(<span class="dv">4</span>).<span class="fu">props</span>(</a>
<a class="sourceLine" id="cb6-3" data-line-number="3">    WorkerActor.<span class="fu">props</span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb6-4" data-line-number="4">  )</a>
<a class="sourceLine" id="cb6-5" data-line-number="5">)</a></code></pre>
    </div>
    <p>If we run this parallelized version of our program we will get exactly what we expect, a runtime consistently 4
        times lower than the one we were registering with just one worker actor:</p>
    <pre><code>starting 20 jobs
...
processing of the batch took 2500 milliseconds
schedulling master actor restart
starting 20 jobs
...
processing of the batch took 2500 milliseconds
schedulling master actor restart
starting 20 jobs
...
processing of the batch took 2500 milliseconds
schedulling master actor restart
starting 20 jobs
...
processing of the batch took 2500 milliseconds</code></pre>
    <h2 id="multiple-process-parallelization">Multiple Process Parallelization</h2>
    <p>The first thing we will try to do is to start another actor system on the same machine but in a different
        process, listening on a different port. This means a new project (at this point), so we’ll have the master
        project and the worker project. On the master project, we need to configure the Akka system to start in
        distributed mode:</p>
    <div class="sourceCode" id="cb8">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb8-1" data-line-number="1">@Bean</a>
<a class="sourceLine" id="cb8-2" data-line-number="2"><span class="kw">def</span> <span class="fu">createActorsSystem</span>(): ActorSystem = {</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">  <span class="kw">val</span> customConfiguration = ConfigFactory.<span class="fu">parseString</span>(</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    <span class="st">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb8-5" data-line-number="5">      |akka {</a>
<a class="sourceLine" id="cb8-6" data-line-number="6">      |  actor {</a>
<a class="sourceLine" id="cb8-7" data-line-number="7">      |    provider = remote</a>
<a class="sourceLine" id="cb8-8" data-line-number="8">      |  }</a>
<a class="sourceLine" id="cb8-9" data-line-number="9">      |  remote {</a>
<a class="sourceLine" id="cb8-10" data-line-number="10">      |    enabled-transports = [<span class="st">&quot;akka.remote.netty.tcp&quot;</span>]</a>
<a class="sourceLine" id="cb8-11" data-line-number="11">      |    netty.<span class="fu">tcp</span> {</a>
<a class="sourceLine" id="cb8-12" data-line-number="12">      |      hostname = <span class="st">&quot;127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb8-13" data-line-number="13">      |      port = <span class="st">&quot;2553&quot;</span></a>
<a class="sourceLine" id="cb8-14" data-line-number="14">      |    }</a>
<a class="sourceLine" id="cb8-15" data-line-number="15">      | }</a>
<a class="sourceLine" id="cb8-16" data-line-number="16">      |}</a>
<a class="sourceLine" id="cb8-17" data-line-number="17">    <span class="st">&quot;&quot;&quot;.stripMargin)</span></a>
<a class="sourceLine" id="cb8-18" data-line-number="18">  <span class="fu">ActorSystem</span>(<span class="st">&quot;distributedSystem&quot;</span>, ConfigFactory.<span class="fu">load</span>(customConfiguration))</a>
<a class="sourceLine" id="cb8-19" data-line-number="19">}</a></code></pre>
    </div>
    <p>In the master project, we just need to create the master actor, but we also need to configure it to access the
        worker actors remotely, so this is how we initialize the reference to the worker actor inside the master actor:</p>
    <div class="sourceCode" id="cb9">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb9-1" data-line-number="1"><span class="kw">private</span> <span class="kw">val</span> worker = context.<span class="fu">actorSelection</span>(<span class="st">&quot;akka.tcp://distributedSystemWorkers@127.0.0.1:2552/user/workerActor&quot;</span>)</a></code></pre>
    </div>
    <p>Next, we need to create the worker project, very similar to the master one but with the code that initializes
        and runs the worker actor. An important thing to pay attention to is that the case classes you use to
        communicate between the two projects are in the same packages. The initialization of the worker system and the
        worker actor:</p>
    <div class="sourceCode" id="cb10">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb10-1" data-line-number="1">@SpringBootApplication</a>
<a class="sourceLine" id="cb10-2" data-line-number="2"><span class="kw">class</span> Configuration {</a>
<a class="sourceLine" id="cb10-3" data-line-number="3"></a>
<a class="sourceLine" id="cb10-4" data-line-number="4">  @Bean</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">  <span class="kw">def</span> <span class="fu">createActorsSystem</span>(): ActorSystem = {</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    <span class="kw">val</span> customConfiguration = ConfigFactory.<span class="fu">parseString</span>(</a>
<a class="sourceLine" id="cb10-7" data-line-number="7">      <span class="st">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb10-8" data-line-number="8">        |akka {</a>
<a class="sourceLine" id="cb10-9" data-line-number="9">        |  actor {</a>
<a class="sourceLine" id="cb10-10" data-line-number="10">        |    provider = remote</a>
<a class="sourceLine" id="cb10-11" data-line-number="11">        |  }</a>
<a class="sourceLine" id="cb10-12" data-line-number="12">        |  remote {</a>
<a class="sourceLine" id="cb10-13" data-line-number="13">        |    enabled-transports = [<span class="st">&quot;akka.remote.netty.tcp&quot;</span>]</a>
<a class="sourceLine" id="cb10-14" data-line-number="14">        |    netty.<span class="fu">tcp</span> {</a>
<a class="sourceLine" id="cb10-15" data-line-number="15">        |      hostname = <span class="st">&quot;127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb10-16" data-line-number="16">        |      port = <span class="dv">2552</span></a>
<a class="sourceLine" id="cb10-17" data-line-number="17">        |    }</a>
<a class="sourceLine" id="cb10-18" data-line-number="18">        | }</a>
<a class="sourceLine" id="cb10-19" data-line-number="19">        |}</a>
<a class="sourceLine" id="cb10-20" data-line-number="20">      <span class="st">&quot;&quot;&quot;.stripMargin)</span></a>
<a class="sourceLine" id="cb10-21" data-line-number="21">    <span class="fu">ActorSystem</span>(<span class="st">&quot;distributedSystemWorkers&quot;</span>, ConfigFactory.<span class="fu">load</span>(customConfiguration))</a>
<a class="sourceLine" id="cb10-22" data-line-number="22">  }</a>
<a class="sourceLine" id="cb10-23" data-line-number="23"></a>
<a class="sourceLine" id="cb10-24" data-line-number="24">  @<span class="fu">Bean</span>(Array(<span class="st">&quot;workerActor&quot;</span>))</a>
<a class="sourceLine" id="cb10-25" data-line-number="25">  <span class="kw">def</span> <span class="fu">createWorkerActor</span>(actorSystem: ActorSystem): ActorRef = {</a>
<a class="sourceLine" id="cb10-26" data-line-number="26">    actorSystem.<span class="fu">actorOf</span>(</a>
<a class="sourceLine" id="cb10-27" data-line-number="27">      <span class="fu">RoundRobinPool</span>(<span class="dv">4</span>).<span class="fu">props</span>(</a>
<a class="sourceLine" id="cb10-28" data-line-number="28">        WorkerActor.<span class="fu">props</span>(<span class="dv">500</span>)</a>
<a class="sourceLine" id="cb10-29" data-line-number="29">      ), <span class="st">&quot;workerActor&quot;</span>)</a>
<a class="sourceLine" id="cb10-30" data-line-number="30">  }</a>
<a class="sourceLine" id="cb10-31" data-line-number="31">}</a></code></pre>
    </div>
    <p>If we now start the two projects (start the worker first) we should see the following output on the master:</p>
    <div class="sourceCode" id="cb11">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb11-1" data-line-number="1">processing of the batch took <span class="dv">2628</span> milliseconds</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">schedulling master actor restart</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">starting <span class="dv">20</span> jobs</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">processing of the batch took <span class="dv">2512</span> milliseconds</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">schedulling master actor restart</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">starting <span class="dv">20</span> jobs</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">processing of the batch took <span class="dv">2500</span> milliseconds</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">schedulling master actor restart</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">starting <span class="dv">20</span> jobs</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">processing of the batch took <span class="dv">2500</span> milliseconds</a>
<a class="sourceLine" id="cb11-11" data-line-number="11">schedulling master actor restart</a>
<a class="sourceLine" id="cb11-12" data-line-number="12">starting <span class="dv">20</span> jobs</a>
<a class="sourceLine" id="cb11-13" data-line-number="13">processing of the batch took <span class="dv">2530</span> milliseconds</a>
<a class="sourceLine" id="cb11-14" data-line-number="14">schedulling master actor restart</a>
<a class="sourceLine" id="cb11-15" data-line-number="15">starting <span class="dv">20</span> jobs</a></code></pre>
    </div>
    <p>We can see that the results are roughly the same, very little overhead registered on some of the jobs.</p>
    <p>Of course this setup is not very usefull, we need to know what the address and port of every remote system is
        and get access to actors on that system. What would be a lot more usefull is if we could make a setup where
        everything is a lot more transparent, where we can have a system that we can grow by adding new nodes to it,
        and the work done by akka actors gets distributed over these nodes without extra configuration. And this
        exactly what can be achieved with an Akka cluster configuration.</p>
    <h2 id="akka-cluster">Akka Cluster</h2>
    <p>The first change we need to make is to configure our app to be able to run on the same machine but on different
        ports, because we’ll test this on a single machine. This means we need to configure the spring server port and
        the Akka system port. This can be done easily with Spring by using program arguments starting with <code>--</code>.
        So we add the following as program arguments to our instances of <code>DistributedApplication</code> (we’ll use
        3 instances to test):</p>
    <ul>
        <li>instance 1 program arguments: <code>--server.port=8080 --akka.system.port=2551 --logging.file=log1</code></li>
        <li>instance 2 program arguments: <code>--server.port=9090 --akka.system.port=2552 --logging.file=log2</code></li>
        <li>instance 3 program arguments: <code>--server.port=9091 --akka.system.port=2553 --logging.file=log3</code></li>
    </ul>
    <p>Then we need to update our Spring startup class to read those arguments:</p>
    <div class="sourceCode" id="cb12">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb12-1" data-line-number="1"><span class="kw">object</span> DistributedApplication {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2"></a>
<a class="sourceLine" id="cb12-3" data-line-number="3">  <span class="kw">def</span> <span class="fu">main</span>(args: Array[String]): Unit = {</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">    SpringApplication.<span class="fu">run</span>(classOf[Configuration], args:_*)</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">  }</a>
<a class="sourceLine" id="cb12-6" data-line-number="6"></a>
<a class="sourceLine" id="cb12-7" data-line-number="7">}</a></code></pre>
    </div>
    <p>The <code>server.port</code> and <code>logging.file</code> properties are supported by Spring and we don’t need
        to do anything else to make them work, but we need to inject the <code>akka.system.port</code> property in our
        configuration class, so we can use it when we configure the Akka system:</p>
    <div class="sourceCode" id="cb13">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb13-1" data-line-number="1">@SpringBootApplication</a>
<a class="sourceLine" id="cb13-2" data-line-number="2"><span class="kw">class</span> Configuration {</a>
<a class="sourceLine" id="cb13-3" data-line-number="3"></a>
<a class="sourceLine" id="cb13-4" data-line-number="4">  @<span class="fu">Value</span>(<span class="st">&quot;${akka.system.port}&quot;</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">  @BeanProperty</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">  <span class="kw">val</span> akkaPort: String = <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb13-7" data-line-number="7"></a>
<a class="sourceLine" id="cb13-8" data-line-number="8">}</a></code></pre>
    </div>
    <p>This part is done, next we configure the akka system to run in clustered mode. We use the following custom
        configuration when we initialize the Akka system (and to which we inject the <code>akka.system.port</code>
        property):</p>
    <div class="sourceCode" id="cb14">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb14-1" data-line-number="1">@SpringBootApplication</a>
<a class="sourceLine" id="cb14-2" data-line-number="2"><span class="kw">class</span> Configuration {</a>
<a class="sourceLine" id="cb14-3" data-line-number="3"></a>
<a class="sourceLine" id="cb14-4" data-line-number="4">  @<span class="fu">Value</span>(<span class="st">&quot;${akka.system.port}&quot;</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">  @BeanProperty</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">  <span class="kw">val</span> akkaPort: String = <span class="st">&quot;&quot;</span></a>
<a class="sourceLine" id="cb14-7" data-line-number="7"></a>
<a class="sourceLine" id="cb14-8" data-line-number="8">  @Bean</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">  <span class="kw">def</span> <span class="fu">createActorsSystem</span>(): ActorSystem = {</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">    <span class="kw">val</span> customConfiguration = ConfigFactory.<span class="fu">parseString</span>(</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">      s<span class="st">&quot;&quot;&quot;</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12">        |akka {</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">        |  actor {</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">        |    provider = cluster</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">        |  }</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">        |  remote {</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">        |    netty.<span class="fu">tcp</span> {</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">        |      hostname = <span class="st">&quot;127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb14-19" data-line-number="19">        |      port = $akkaPort</a>
<a class="sourceLine" id="cb14-20" data-line-number="20">        |    }</a>
<a class="sourceLine" id="cb14-21" data-line-number="21">        |    artery {</a>
<a class="sourceLine" id="cb14-22" data-line-number="22">        |      enabled = on</a>
<a class="sourceLine" id="cb14-23" data-line-number="23">        |      canonical.<span class="fu">hostname</span> = <span class="st">&quot;127.0.0.1&quot;</span></a>
<a class="sourceLine" id="cb14-24" data-line-number="24">        |      canonical.<span class="fu">port</span> = $akkaPort</a>
<a class="sourceLine" id="cb14-25" data-line-number="25">        |    }</a>
<a class="sourceLine" id="cb14-26" data-line-number="26">        |  }</a>
<a class="sourceLine" id="cb14-27" data-line-number="27">        |</a>
<a class="sourceLine" id="cb14-28" data-line-number="28">        |  cluster {</a>
<a class="sourceLine" id="cb14-29" data-line-number="29">        |    seed-nodes = [</a>
<a class="sourceLine" id="cb14-30" data-line-number="30">        |      <span class="st">&quot;akka://distributedSystem@127.0.0.1:2551&quot;</span>,</a>
<a class="sourceLine" id="cb14-31" data-line-number="31">        |      <span class="st">&quot;akka://distributedSystem@127.0.0.1:2552&quot;</span>]</a>
<a class="sourceLine" id="cb14-32" data-line-number="32">        |</a>
<a class="sourceLine" id="cb14-33" data-line-number="33">        |    auto-down-unreachable-after = 10s</a>
<a class="sourceLine" id="cb14-34" data-line-number="34">        |  }</a>
<a class="sourceLine" id="cb14-35" data-line-number="35">        |</a>
<a class="sourceLine" id="cb14-36" data-line-number="36">        |}</a>
<a class="sourceLine" id="cb14-37" data-line-number="37">      <span class="st">&quot;&quot;&quot;.stripMargin)</span></a>
<a class="sourceLine" id="cb14-38" data-line-number="38">    <span class="fu">ActorSystem</span>(<span class="st">&quot;distributedSystem&quot;</span>, ConfigFactory.<span class="fu">load</span>(customConfiguration))</a>
<a class="sourceLine" id="cb14-39" data-line-number="39">  }</a>
<a class="sourceLine" id="cb14-40" data-line-number="40">}</a></code></pre>
    </div>
    <p>The configuration tells our <code>distributedSystem</code> that actors are provided by the cluster, that the
        system should start on the IP <code>127.0.0.1</code> and the port configured by the <code>akka.system.port</code>
        property, and metions what the seed nodes of the cluster are.</p>
    <p>Another thing we’ll do for this example application is make sure we start one master actor, only on one of the
        nodes:</p>
    <div class="sourceCode" id="cb15">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb15-1" data-line-number="1">@<span class="fu">Bean</span>(Array(<span class="st">&quot;masterActor&quot;</span>))</a>
<a class="sourceLine" id="cb15-2" data-line-number="2"><span class="kw">def</span> <span class="fu">createMasterActor</span>(actorSystem: ActorSystem): ActorRef = {</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">  <span class="kw">if</span> (akkaPort == <span class="st">&quot;2551&quot;</span>) actorSystem.<span class="fu">actorOf</span>(Props.<span class="fu">create</span>(classOf[MasterActor]), <span class="st">&quot;masterActor&quot;</span>)</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">  <span class="kw">else</span> <span class="kw">null</span></a>
<a class="sourceLine" id="cb15-5" data-line-number="5">}</a></code></pre>
    </div>
    <p>Then we also create a worker on each node we start up:</p>
    <div class="sourceCode" id="cb16">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb16-1" data-line-number="1">@<span class="fu">Bean</span>(Array(<span class="st">&quot;workerActor&quot;</span>))</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="kw">def</span> <span class="fu">createWorkerActor</span>(actorSystem: ActorSystem): ActorRef = {</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  actorSystem.<span class="fu">actorOf</span>(WorkerActor.<span class="fu">props</span>(<span class="dv">500</span>), <span class="st">&quot;workerActor&quot;</span>)</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">}</a></code></pre>
    </div>
    <p>Now, our master needs a way to send work to all workers in a cluster, however many workers there are in the
        cluster at one time. For this, we need to create a router in our master than can detect when new nodes are
        added to the cluster and select the worker actors on those nodes by path (changes in <code>MasterActor.scala</code>):</p>
    <div class="sourceCode" id="cb17">
        <pre class="sourceCode scala"><code class="sourceCode scala"><a class="sourceLine" id="cb17-1" data-line-number="1"><span class="kw">private</span> <span class="kw">val</span> worker = context.<span class="fu">actorOf</span>(</a>
<a class="sourceLine" id="cb17-2" data-line-number="2">  <span class="fu">ClusterRouterGroup</span>(</a>
<a class="sourceLine" id="cb17-3" data-line-number="3">    <span class="fu">RoundRobinGroup</span>(List(<span class="st">&quot;/user/workerActor&quot;</span>)),</a>
<a class="sourceLine" id="cb17-4" data-line-number="4">    <span class="fu">ClusterRouterGroupSettings</span>(</a>
<a class="sourceLine" id="cb17-5" data-line-number="5">      totalInstances = <span class="dv">100</span>,</a>
<a class="sourceLine" id="cb17-6" data-line-number="6">      routeesPaths = List(<span class="st">&quot;/user/workerActor&quot;</span>),</a>
<a class="sourceLine" id="cb17-7" data-line-number="7">      allowLocalRoutees = <span class="kw">true</span>,</a>
<a class="sourceLine" id="cb17-8" data-line-number="8">      useRoles = Set(<span class="st">&quot;dc-default&quot;</span>)</a>
<a class="sourceLine" id="cb17-9" data-line-number="9">    )</a>
<a class="sourceLine" id="cb17-10" data-line-number="10">  ).<span class="fu">props</span>()</a>
<a class="sourceLine" id="cb17-11" data-line-number="11">)</a></code></pre>
    </div>
    <p>Ok, now we are ready to start our application, one instance at a time. We start the first instance, the one that
        creates our master actor and one worker actor, and we follow the outputted logs. We’ll get the following
        performance:</p>
    <pre><code>starting 20 jobs
worker actor received message 3871350820359
worker actor received message 3871350833951
worker actor received message 3871350835839
worker actor received message 3871350836972
worker actor received message 3871350837727
worker actor received message 3871350838482
worker actor received message 3871350839237
worker actor received message 3871350839992
worker actor received message 3871350840747
worker actor received message 3871350841125
worker actor received message 3871350841880
worker actor received message 3871350842635
worker actor received message 3871350843390
worker actor received message 3871350848299
worker actor received message 3871350849054
worker actor received message 3871350849809
worker actor received message 3871350850564
worker actor received message 3871350851319
worker actor received message 3871350851697
worker actor received message 3871350852829
processing of the batch took 10022 milliseconds
schedulling master actor restart</code></pre>
    <p>So yes, the master actor starts 20 tasks, the worker actor on this node takes all the tasks and processes them,
        each task takes 500 milliseconds so in total it takes 10 seconds to do the work.</p>
    <p>But now let’s start the second instance of our application and watch what the logs print on our master instance:</p>
    <pre><code>starting 20 jobs
worker actor received message 3901444757951
worker actor received message 3901444760971
worker actor received message 3901444761349
worker actor received message 3901444771921
worker actor received message 3901444772298
worker actor received message 3901444772676
worker actor received message 3901444773431
worker actor received message 3901444773808
worker actor received message 3901444774186
worker actor received message 3901444774564
processing of the batch took 5023 milliseconds
schedulling master actor restart</code></pre>
    <p>After the master started 20 jobs, the worker actor on the main node only received 10 of them, but the work was
        completed and it took half the time. This means that the second node has successfully joined the cluster and
        the second worker actor was discovered by the router in the master, and work was routed to it. If we look at
        the logs of the second node we’ll see the <code>worker actor received message</code> printouts that confirm the
        work is being done by this node also.</p>
    <p>Predictably, if we also start the third node, the work will be done even faster:</p>
    <pre><code>starting 20 jobs
worker actor received message 3921544041517
worker actor received message 3921544042649
worker actor received message 3921544043027
worker actor received message 3921544043782
worker actor received message 3921544044160
worker actor received message 3921544044915
worker actor received message 3921544045670
processing of the batch took 3514 milliseconds
schedulling master actor restart</code></pre>
    <p>This achieves our goal of building a powerful service that we can parallelize very easily and spread the
        workload over multiple nodes (on a machine, on an actual cluster). With Akka, this switch from a single node to
        multiple nodes requires only minimal changes in your application. In conclusion, besides the fact that Akka,
        with the actor model it implements, makes writing multi-threadded applications more manageable, adopting it
        also gives you the option of deploying your processing application on multiple machines when the need requires
        it, and makes this multi-node configuration also very easy to adopt.</p>
</body>

</html>